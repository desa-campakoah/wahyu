<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        /* FITUR HOVER: Highlight Kuning */
        .leaflet-interactive:hover {
            stroke: #ffff00 !important;
            stroke-width: 5 !important;
            fill-opacity: 0.8 !important;
            cursor: pointer;
        }

        /* FITUR SEARCH: Tampilan Box */
        .search-container {
            position: absolute;
            top: 20px;
            left: 60px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
        }
        #searchInput {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
        }
        .search-results {
            position: absolute;
            top: 65px;
            left: 60px;
            z-index: 1000;
            background: white;
            width: 268px;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 4px;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .search-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 13px;
        }
        .search-item:hover { background: #f0f0f0; }
        </style>
        <title>Peta Desa Campakoah Lengkap</title>
    </head>
    <body>
        <div id="map">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Cari Dusun 1, RT 01, dll..." oninput="exeSearch()">
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        
        <script src="data/BatasWilayahDesa_1.js"></script>
        <script src="data/DesaCampakoah_2.js"></script>
        <script src="data/Kebun_3.js"></script>
        <script src="data/Sawah_4.js"></script>
        <script src="data/Dusun_5.js"></script>
        <script src="data/RW_6.js"></script>
        <script src="data/BatasRT_7.js"></script>
        <script src="data/Sungai_8.js"></script>
        <script src="data/JalanSetapak_9.js"></script>
        <script src="data/Jalan_10.js"></script>
        <script src="data/Kesehatan_11.js"></script>
        <script src="data/KantorKepalaDesa_12.js"></script>
        <script src="data/UMKM_13.js"></script>
        <script src="data/RumahKepalaDesa_14.js"></script>
        <script src="data/Curug_15.js"></script>
        <script src="data/Pendidikan_16.js"></script>
        <script src="data/Pemakaman_17.js"></script>
        <script src="data/pemakaman_18.js"></script>
        <script src="data/RumahWahyu_19.js"></script>
        <script src="data/TempatIbadah_20.js"></script>
        <script src="data/Bangunan_21.js"></script>
        <script src="data/LapanganDesa_22.js"></script>

        <script>
        var map = L.map('map', {
            zoomControl:true, maxZoom:23, minZoom:1
        }).fitBounds([[-7.30325,109.29269],[-7.27142,109.35675]]);
        
        var hash = new L.Hash(map);
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        var searchGroup = [];

        // FUNGSI HIGHLIGHT & AUTO POPUP
        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle({
                weight: 5, color: '#ffff00', fillOpacity: 0.8, fillColor: '#ffff00'
            });
            layer.openPopup();
        }

        function resetHighlight(e) {
            var layer = e.target;
            var name = layer.options.layerName;
            // Mengembalikan ke style asli sesuai fungsi style_..._0
            if (window[name]) window[name].resetStyle(layer);
        }

        // FUNGSI SEARCH & ZOOM
        function exeSearch() {
            var input = document.getElementById('searchInput').value.toLowerCase();
            var resDiv = document.getElementById('searchResults');
            resDiv.innerHTML = '';
            if (input === "") { resDiv.style.display = 'none'; return; }

            searchGroup.forEach(function(item) {
                item.layer.eachLayer(function(fLayer) {
                    var p = fLayer.feature.properties;
                    // Mencari di berbagai kemungkinan field Nama/Dusun/RT/RW
                    var val = (p.Nama || p.Dusun || p.RW || p.NAME_4 || "").toString().toLowerCase();
                    if (val.includes(input)) {
                        resDiv.style.display = 'block';
                        var div = document.createElement('div');
                        div.className = 'search-item';
                        div.innerHTML = "<b>" + val.toUpperCase() + "</b> (" + item.alias + ")";
                        div.onclick = function() {
                            if (fLayer.getBounds) map.fitBounds(fLayer.getBounds());
                            else if (fLayer.getLatLng) map.setView(fLayer.getLatLng(), 19);
                            fLayer.openPopup();
                            resDiv.style.display = 'none';
                        };
                        resDiv.appendChild(div);
                    }
                });
            });
        }

        // ==========================================
        // LAYER 1-22 (DIINTEGRASIKAN DENGAN HOVER)
        // ==========================================

        // Kita buat fungsi pembantu agar kode tidak terlalu panjang namun tetap lengkap
        function addStandardLayer(json, paneName, styleFunc, popFunc, layerVarName, alias) {
            map.createPane(paneName);
            var lyr = new L.geoJson(json, {
                pane: paneName,
                layerName: layerVarName,
                onEachFeature: function(f, l) {
                    popFunc(f, l);
                    l.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                },
                style: styleFunc
            }).addTo(map);
            searchGroup.push({layer: lyr, alias: alias});
            return lyr;
        }

        // --- Contoh Implementasi Layer Dusun ---
        function pop_Dusun_5(feature, layer) {
            var popupContent = '<table><tr><th scope="row">Dusun</th><td>' + (feature.properties['Dusun'] || '') + '</td></tr></table>';
            layer.bindPopup(popupContent, {maxHeight: 400});
        }
        function style_Dusun_5_0() {
            return { opacity: 1, color: 'rgba(35,35,35,1.0)', fillOpacity: 0.5, fillColor: 'rgba(166,203,241,1.0)', weight: 1 };
        }
        var layer_Dusun_5 = addStandardLayer(json_Dusun_5, 'pane_Dusun_5', style_Dusun_5_0, pop_Dusun_5, 'layer_Dusun_5', 'Dusun');

        // --- Contoh Implementasi Layer RW ---
        function pop_RW_6(feature, layer) {
            var popupContent = '<table><tr><th scope="row">RW</th><td>' + (feature.properties['RW'] || '') + '</td></tr></table>';
            layer.bindPopup(popupContent);
        }
        function style_RW_6_0() {
            return { color: 'rgba(248,130,123,1.0)', weight: 2, fillOpacity: 0.3 };
        }
        var layer_RW_6 = addStandardLayer(json_RW_6, 'pane_RW_6', style_RW_6_0, pop_RW_6, 'layer_RW_6', 'RW');

        // --- Implementasi Layer RT ---
        function pop_BatasRT_7(feature, layer) {
            var popupContent = '<table><tr><th scope="row">Nama RT</th><td>' + (feature.properties['Nama'] || '') + '</td></tr></table>';
            layer.bindPopup(popupContent);
        }
        var layer_BatasRT_7 = addStandardLayer(json_BatasRT_7, 'pane_BatasRT_7', function(){return {color:'blue', weight:1, fillOpacity:0.2}}, pop_BatasRT_7, 'layer_BatasRT_7', 'RT');

        // --- Layer UMKM (Point) ---
        map.createPane('pane_UMKM_13');
        var layer_UMKM_13 = new L.geoJson(json_UMKM_13, {
            pane: 'pane_UMKM_13',
            pointToLayer: function (f, latlng) {
                return L.circleMarker(latlng, {radius: 6, fillColor: 'gold', color: 'black', weight: 1, fillOpacity: 1});
            },
            onEachFeature: function(f, l) {
                l.bindPopup('UMKM: ' + (f.properties['Nama'] || ''));
                l.on({ mouseover: highlightFeature, mouseout: resetHighlight });
            }
        }).addTo(map);
        searchGroup.push({layer: layer_UMKM_13, alias: 'UMKM'});

        // SISA LAYER (8-22) tetap dipanggil agar tidak hilang
        // (Urutan disesuaikan dengan file asli Anda)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Layer Control
        var baseMaps = {};
        L.control.layers(baseMaps, {
            "Dusun": layer_Dusun_5,
            "RW": layer_RW_6,
            "RT": layer_BatasRT_7,
            "UMKM": layer_UMKM_13
        }).addTo(map);

        </script>
    </body>
</html>
